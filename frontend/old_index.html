<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emscripten WASM Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #output {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
</head>
<body>

<h1>Emscripten WASM Test</h1>
<input type="file" id="fileInput" />
<button id="runFunction">Run WASM Function</button>
<div id="output">Output will appear here.</div>
<div id="tester" style="width:1000px;height:1000px;"></div>
<script type="module" src="wasm/nucleofind.js"></script>
<script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis"></script>

<script type="module">
    // Initialize the Emscripten module
    import nucleofind_module from "./wasm/nucleofind.js";


    const Module = await nucleofind_module()

    document.getElementById("runFunction").addEventListener("click", () => {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
            document.getElementById("output").textContent = "No file selected.";
            return;
        }

        const reader = new FileReader();

        reader.onload = (event) => {
            console.log("Loading file", event)
            const filePath = '/' + "hklout.mtz";
            const fileContents = new Uint8Array(event.target.result);

            // Write the binary file to Emscripten's virtual filesystem
            Module.FS.writeFile(filePath, fileContents);
            console.log("Written file")

            if (Module && Module.test) {
                // Call a function from the WASM module (replace with your function name)
                const result = Module.test(); // Pass arguments as needed
                let data = new Array(32*32*32);
                for (let i = 0; i < result.size(); i++) {
                    data[i] = result.get(i)
                }
                let array = tf.tensor(data);
                array = array.reshape([32,32,32])
                const json = JSON.stringify(array.dataSync());
                const blob = new Blob([json], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'volumeData.json';
                link.click();

                document.getElementById("output").textContent = `Result from WASM: ${result}`;
            } else {
                document.getElementById("output").textContent = "Module not loaded or function not found.";
            }

        };

        reader.readAsArrayBuffer(file);
    });
</script>
</body>
</html>